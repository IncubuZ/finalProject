function connectErrorCallback(e){2==e&&navigator.app.exitApp()}function loadFeedCallback(e){2==e&&loadFeed()}function checkPreAuth(){void 0!==window.localStorage.username&&void 0!==window.localStorage.password?($.mobile.changePage("#homePage"),loadingHide(),navigator.splashscreen.hide()):($.mobile.changePage("#loginRegisPage"),loadingHide(),navigator.splashscreen.hide())}function loadingShow(e){$.mobile.loading("show"),$(e).hide()}function loadingHide(e){$.mobile.loading("hide"),$(e).show()}function onBackbutton(e){$.mobile.activePage.is("#loginRegisPage")?(e.preventDefault(),navigator.app.exitApp()):$.mobile.activePage.is("#homePage")?(e.preventDefault(),navigator.home.home(function(){console.info("Successfully launched home intent")},function(){console.error("Error launching home intent")})):navigator.app.backHistory()}function exitApp(){clearCache(),navigator.app.exitApp()}function deviceReady(){checkConnection(),cordova.exec(null,null,"SplashScreen","hide",[]),clearCache(),checkPreAuth(),document.addEventListener("backbutton",onBackbutton,!1),regisThisDevice()}function clearCache(){var e=function(e){console.log("Message: "+e)},t=function(e){console.log("Error: "+e)};window.cache.clear(e,t)}function checkGroup(){"000000"===window.localStorage.userGroup?($(".disGroupBtn").addClass("ui-state-disabled"),checkNoGroupAlert()!==!0&&$.mobile.changePage("#groupAlertPage")):$(".disGroupBtn").removeClass("ui-state-disabled")}function setNoGroupAlert(){window.localStorage.setItem("noGroupAlert","0")}function IsFirstLaunch(){var e=window.localStorage.getItem("firstlaunch");return e&&0===parseInt(e)?!1:(window.localStorage.setItem("firstlaunch","0"),!0)}function checkNoGroupAlert(){var e=window.localStorage.getItem("noGroupAlert");return e&&0===parseInt(e)?!0:!1}function testVar(){console.log(localStorage.userGroup)}function checkConnection(){var e=navigator.connection.type,t={};t[Connection.UNKNOWN]="Unknown connection",t[Connection.ETHERNET]="Ethernet connection",t[Connection.WIFI]="WiFi connection",t[Connection.CELL_2G]="Cell 2G connection",t[Connection.CELL_3G]="Cell 3G connection",t[Connection.CELL_4G]="Cell 4G connection",t[Connection.CELL]="Cell generic connection",t[Connection.NONE]="No network connection","No network connection"==t[e]&&navigator.notification.confirm("ไม่พบการเชื่อมต่อเครือข่าย ออกจากแอพฯใช่หรือไม่?",connectErrorCallback,"Error","ไม่,ใช่")}function countNotify(){str_count=localStorage.getItem("notifyCount"),count=null===str_count||"null"===str_count?0:parseInt(str_count),count++,localStorage.setItem("notifyCount",count),notifyCount=window.localStorage.getItem("notifyCount"),$(".spNotify").text(notifyCount).fadeOut(100).css("color","#F90").fadeIn(100)}function countNotifyReset(){localStorage.setItem("notifyCount",0),notifyCount=window.localStorage.getItem("notifyCount"),$(".spNotify").text(notifyCount).css("color","")}function countNotifyGet(){0===parseInt(notifyCount)||null===notifyCount||"null"===notifyCount?(localStorage.setItem("notifyCount",0),notifyCount=window.localStorage.getItem("notifyCount"),$(".spNotify").text(notifyCount).css("color","")):$(".spNotify").text(notifyCount).css("color","yellow")}function mainMenuSet(){var e='<ul data-role="listview"><li data-icon="delete"><a data-rel="close" href="#">ปิดเมนู</a></li><li data-icon="recycle"><a data-rel="close" href="#homePage" onclick="loadFeed();">แสดงรายงาน ทั้งหมด</a></li><li data-icon="bars"><a data-rel="close" href="#userReportPage" onclick="loadThisUserReport();">รายงานสถานการณ์ของฉัน</a></li><li data-icon="bullets"><a data-rel="close" href="#groupPage" onclick="loadUserGroup();">แสดงรายงานและจัดการกลุ่ม</a></li><li data-icon="user"><a data-rel="close" href="#profilePage" onclick="getUserDetail();">โปรไฟล์</a></li><li data-icon="plus"><a data-rel="close" class="disGroupBtn" href="#addReportPage" onclick="getCurrentPosition();">เพิ่มรายงาน สถานการณ์</a></li><li data-icon="search"><a data-rel="close" href="#searchPage" onclick="clearSearchFilter();">ค้นหารายงาน สถานการณ์</a></li><li data-icon="lock"><a href="#" onclick="logOut();">ออกจากระบบ</a></li><li data-icon="power"><a href="#" onclick="exitApp();">ออกจากแอพ</a></li></ul>';$(".mainMenu").html(e)}function loginBindEvent(){$("#loginForm").on("submit",handleLogin)}function regisBindEvent(){$("#regisBDate").combodate({value:moment(localStorage.userBdate,"YYYY-MM-DD"),template:"DD MMMM YYYY",minYear:1900,maxYear:moment().format("YYYY")}),validAll(),$("#userInputRegis").on("focusout",checkUsedName).on("focusin",function(){$("#pMsgU").text(userMsgD).css("color","black")}),$("#passInputRegis").on("focusout",checkPass).on("focusout",checkUsedName).on("focusin",function(){$("#pMsgP").text(passMsgD).css("color","black")}),$("#repassInputRegis").on("focusout",recheckPass),$("#emailInputRegis").on("focusout",checkEmail),$("#nameInput").on("focusout",function(){$("#nameInput").val()?(realNameState=!0,validAll()):(realNameState=!1,validAll())}),$("#surnameInput").on("focusout",function(){$("#surnameInput").val()?(realSNameState=!0,validAll()):(realSNameState=!1,validAll())}),$("#regisBDate").on("change",function(){$("#regisBDate").val()?(bDateState=!0,validAll()):(bDateState=!1,validAll())}),$("#sumitBtn").on("click",handleRegis)}function handleLogin(){var e=$("#loginForm"),t=serviceURL+"handle_login.php";loadingShow("#contentLogin"),$("#submitButton",e).attr("disabled","disabled");var o=$("#username",e).val(),a=$("#password",e).val();return""!==o&&""!==a?$.ajax({type:"GET",url:t,contentType:"application/json",dataType:"jsonp",data:{username:o,password:a},crossDomain:!0,timeout:1e4,success:function(t){jQuery.isEmptyObject(t)?navigator.notification.alert("Your login failed",function(){}):(window.localStorage.username=o,window.localStorage.password=a,window.localStorage.userId=t.user_id,window.localStorage.userRName=t.user_rname,window.localStorage.userSurname=t.user_surname,window.localStorage.userEmail=t.user_email,window.localStorage.userBdate=t.user_bdate,window.localStorage.userGender=t.user_gender,window.localStorage.userImageUrl=t.user_imageUrl,window.localStorage.userStatus=t.user_status,window.localStorage.userGroup=t.user_group,userFooterSet(),regisThisDevice(),$(e)[0].reset(),$.mobile.changePage("#homePage"),checkGroup(),loadFeed()),$("#submitButton").removeAttr("disabled"),loadingHide("#contentLogin")},error:function(){navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต "),loadingHide("#contentLogin")},complete:function(){$("#submitButton").removeAttr("disabled"),loadingHide("#contentLogin")}}):(navigator.notification.alert("You must enter a username and password",function(){}),$("#submitButton").removeAttr("disabled"),loadingHide("#contentLogin")),!1}function handleRegis(){var e=$("#regisForm"),t=serviceURL+"regisUser.php";$("#sumitBtn").addClass("ui-state-disabled");var o=$("#userInputRegis",e).val(),a=$("#passInputRegis",e).val(),r=$("#emailInputRegis",e).val(),i=$("#nameInput",e).val(),n=$("#surnameInput",e).val(),l=$("#genderSelect",e).val(),s=moment($("#regisBDate").val(),"DD-MM-YYYY").format("YYYY-MM-DD");return loadingShow("#contentRegis"),validAll()?$.ajax({type:"GET",url:t,contentType:"application/json",dataType:"jsonp",data:{username:o,password:a,email:r,realname:i,realsname:n,gender:l,bday:s},crossDomain:!0,timeout:1e4,success:function(t){jQuery.isEmptyObject(t)?navigator.notification.alert("Your login failed",function(){}):(window.localStorage.username=o,window.localStorage.password=a,window.localStorage.userId=t.user_id,window.localStorage.userRName=t.user_rname,window.localStorage.userSurname=t.user_surname,window.localStorage.userEmail=t.user_email,window.localStorage.userBdate=t.user_bdate,window.localStorage.userGender=t.user_gender,window.localStorage.userImageUrl=t.user_imageUrl,window.localStorage.userStatus=t.user_status,window.localStorage.userGroup=t.user_group,userFooterSet(),regisThisDevice(),$(e)[0].reset(),$("#pMsgU").text(""),$("#pMsgP").text(""),$("#pMsgE").text(""),userState=!1,passState=!1,emailState=!1,realNameState=!1,realSNameState=!1,validAll(),$.mobile.changePage("#homePage"),checkGroup(),loadFeed()),$("#sumitBtn").removeClass("ui-state-disabled"),loadingHide("#contentRegis")},error:function(){navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต "),$("#sumitBtn").removeClass("ui-state-disabled"),loadingHide("#contentRegis")},complete:function(){}}):(navigator.notification.alert("You must fill form"),$("#submitButton").removeAttr("disabled"),loadingHide("#contentRegis")),!1}function dateNow(){var e=new Date,t=("0"+e.getDate()).slice(-2),o=("0"+(e.getMonth()+1)).slice(-2),a=e.getFullYear()+"-"+o+"-"+t;$("#datePicker").val(a)}function validAll(){return userState===!0&&passState===!0&&emailState===!0&&realNameState===!0&&realSNameState===!0&&bDateState===!0?($("#sumitBtn").removeClass("ui-state-disabled"),!0):($("#sumitBtn").addClass("ui-state-disabled"),!1)}function checkUsernameRegEx(e){var t=/^[a-z0-9_-]{4,15}$/;return t.test(e)?!0:!1}function checkEmailRegEx(e){var t=/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,5}$/;return t.test(e)?!0:!1}function checkPasswordRegEx(e){var t=/^[a-zA-Z0-9_-]{5,15}$/;return t.test(e)?!0:!1}function checkUsedName(){var e=$("#regisForm"),t=$("#userInputRegis").val(),o=serviceURL+"checkUsedName.php";return""!==t?checkUsernameRegEx(t)===!0?$.ajax({type:"GET",url:o,contentType:"application/json",dataType:"jsonp",data:{username:t},crossDomain:!0,timeout:1e4,success:function(o){o.success===!0?(userState=!1,validAll(),$("#pMsgU").text(t+" ชื่อนี้มีผู้ใช้แล้ว").css("color","red"),$("#userInputRegis",e).val("")):(userState=!0,validAll(),$("#pMsgU").text(t+" ชื่อนี้สามารถใช้ได้").css("color","green"))},error:function(){userState=!1,validAll(),navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต ")},complete:function(){console.log("checkUsedName complete")}}):(userState=!1,validAll(),$("#pMsgU").text(userMsgD).css("color","red")):(userState=!1,validAll(),$("#pMsgU").text("กรุณากรอก Username").css("color","red")),!1}function checkPass(){var e=$("#regisForm"),t=$("#passInputRegis",e).val();""!==t?checkPasswordRegEx(t)===!0?(passState=!1,validAll(),$("#pMsgP").text(" กรอกรหัสอีกครั้ง ").css("color","black")):(passState=!1,validAll(),$("#pMsgP").text(passMsgD).css("color","red")):(passState=!1,validAll(),$("#pMsgP").text(" กรุณากรอก Password ").css("color","red"))}function recheckPass(){var e=$("#regisForm"),t=$("#passInputRegis",e).val(),o=$("#repassInputRegis",e).val();""!==o?checkPasswordRegEx(o)===!0?t==o?(passState=!0,validAll(),$("#pMsgP").text(" รหัสผ่านนี้สามารถใช้ได้").css("color","green")):(passState=!1,validAll(),$("#pMsgP").text(" รหัสผ่านนี้ไม่ตรงกัน").css("color","red")):(passState=!1,validAll(),$("#pMsgP").text(passMsgD).css("color","red")):(passState=!1,validAll(),$("#pMsgP").text(" กรุณากรอก Password อีกครั้ง").css("color","red"))}function checkEmail(){var e=$("#regisForm"),t=$("#emailInputRegis",e).val(),o=serviceURL+"checkUsedEmail.php";return""!==t?checkEmailRegEx(t)===!0?$.ajax({type:"GET",url:o,contentType:"application/json",dataType:"jsonp",data:{email:t},crossDomain:!0,timeout:1e4,success:function(e){e.success===!0?(emailState=!1,validAll(),$("#pMsgE").text(" Email นี้มีผู้ใช้แล้ว").css("color","red")):(emailState=!0,validAll(),$("#pMsgE").text(" Email นี้สามารถใช้ได้").css("color","green"))},error:function(){emailState=!1,validAll(),navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต")},complete:function(){console.log("checkEmail complete")}}):(emailState=!1,validAll(),$("#pMsgE").text(" กรุณากรอก Email ให้ถูกต้อง ").css("color","red")):(emailState=!1,validAll(),$("#pMsgE").text("กรุณากรอก Email").css("color","red")),!1}function logOut(){localStorage.removeItem("username"),localStorage.removeItem("password"),localStorage.removeItem("userId"),localStorage.removeItem("userRName"),localStorage.removeItem("userSurname"),localStorage.removeItem("userEmail"),localStorage.removeItem("userBdate"),localStorage.removeItem("userGender"),localStorage.removeItem("userImageUrl"),localStorage.removeItem("userStatus"),localStorage.removeItem("userGroup"),localStorage.removeItem("noGroupAlert"),deleteThisDevice(),countNotifyReset(),$.mobile.changePage("#loginRegisPage")}function userFooterSet(){$(".userFooter").text(window.localStorage.userRName+" "+window.localStorage.userSurname)}function getUserDetail(){clearCache();var e=moment(),t="";t="male"===localStorage.userGender?"ชาย":"female"===localStorage.userGender?"หญิง":"อื่นๆ",loadingShow("#contentProfile"),$("#imgPropic").attr("src",serviceURL+"../img/userprofileimage/"+localStorage.userImageUrl+"?"+e.format()),$("#spNamePro").text(localStorage.userRName+" "+localStorage.userSurname),$("#spGenderPro").text(t),$("#spBirthPro").text(moment(localStorage.userBdate,"YYYY-MM-DD","th").format("LL")),$("#spEmailPro").text(localStorage.userEmail),loadingHide("#contentProfile")}function getEditUserDetail(){clearCache();var e=moment();$("#imgEditPropic").attr("src",serviceURL+"../img/userprofileimage/"+localStorage.userImageUrl+"?"+e.format()),$("#nameEditInput").val(localStorage.userRName),$("#surnameEditInput").val(localStorage.userSurname);var t=$("#genderEditSelect");t.val(localStorage.userGender).attr("selected",!0).siblings("option").removeAttr("selected"),t.selectmenu().selectmenu("refresh",!0),$("#genderEditSelect").val(localStorage.userGender),$("#emailEditInput").val(localStorage.userEmail),$("#editBDate").combodate({value:moment(localStorage.userBdate,"YYYY-MM-DD"),template:"DD MMMM YYYY",minYear:1900,maxYear:moment().format("YYYY")})}function getImage(){clearCache(),navigator.camera.getPicture(getImageSuccess,function(){alert("get picture failed")},{quality:100,destinationType:navigator.camera.DestinationType.FILE_URI,sourceType:navigator.camera.PictureSourceType.PHOTOLIBRARY,targetWidth:130,targetHeight:130,correctOrientation:1,saveToPhotoAlbum:0,allowEdit:1})}function takeImage(){clearCache(),navigator.camera.getPicture(getImageSuccess,function(){alert("get picture failed")},{quality:100,destinationType:Camera.DestinationType.FILE_URI,targetWidth:130,targetHeight:130,correctOrientation:1,saveToPhotoAlbum:0,allowEdit:1})}function getImageSuccess(e){globalProfileImageURI=e,$("#imgEditPropic").attr("src",globalProfileImageURI),$("#imgPropic").attr("src",globalProfileImageURI);moment();uploadPhotoProfileData(e)}function uploadPhotoProfileData(e){var t=new FileUploadOptions;t.fileKey="file",t.fileName=e.substr(e.lastIndexOf("/")+1),t.mimeType="image/jpeg";var o=new Object;o.userId=localStorage.userId,t.params=o,t.chunkedMode=!1;var a=new FileTransfer;a.upload(e,encodeURI(serviceURL+"updatePicProfile.php"),uploadProPicwin,uploadProPicfail,t)}function uploadProPicwin(){alert("เปลี่ยนรูปโปรไฟล์ เรียบร้อยแล้ว!"),getUserDetail()}function uploadProPicfail(e){alert("An error has occurred: Code = "+e.code)}function editUserBindEvent(){$("#nameEditInput").on("focusin",function(){editState=!1}).on("keyup",function(){editState=!0}).on("focusout",updateRName),$("#surnameEditInput").on("focusin",function(){editState=!1}).on("keyup",function(){editState=!0}).on("focusout",updateSurName),$("#genderEditSelect").on("change",updateGender),$("#editBDate").on("change",updateBDate),$("#emailEditInput").on("focusin",function(){editState=!1}).on("keyup",function(){editState=!0}).on("focusout",checkEditEmail)}function updateRName(){if(editState===!0){$("#pMsgEditRname").text("กำลังดำเนินการ").css("color","blue").show();var e=localStorage.userId,t=$("#nameEditInput").val(),o=serviceURL+"updateUserProfile.php";return""!==t?$.ajax({type:"GET",url:o,contentType:"application/json",dataType:"jsonp",data:{userid:e,realname:t},crossDomain:!0,timeout:1e4,success:function(e){e.success===!0?(window.localStorage.userRName=t,getUserDetail(),getEditUserDetail(),$("#pMsgEditRname").text("เปลี่ยนชื่อเป็น "+t+" เรียบร้อยแล้ว").css("color","green").fadeOut(3200)):$("#pMsgEditRname").text("มีบางอย่างผิดพลาด").css("color","red")},error:function(){navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต ")},complete:function(){console.log("complete")}}):$("#pMsgEditRname").text("กรุณากรอกชื่อจริงของคุณ").css("color","red").show(),!1}}function updateSurName(){if(editState===!0){$("#pMsgEditSurname").text("กำลังดำเนินการ").css("color","blue").show();var e=localStorage.userId,t=$("#surnameEditInput").val(),o=serviceURL+"updateUserProfile.php";return""!==t?$.ajax({type:"GET",url:o,contentType:"application/json",dataType:"jsonp",data:{userid:e,realsname:t},crossDomain:!0,timeout:1e4,success:function(e){e.success===!0?(window.localStorage.userSurname=t,getUserDetail(),getEditUserDetail(),$("#pMsgEditSurname").text("เปลี่ยนนามสกุลเป็น "+t+" เรียบร้อยแล้ว").css("color","green").fadeOut(3200)):$("#pMsgEditSurname").text("มีบางอย่างผิดพลาด").css("color","red")},error:function(){navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต ")},complete:function(){console.log("complete")}}):$("#pMsgEditSurname").text("กรุณากรอกนามสกุลจริงของคุณ").css("color","red").show(),!1}}function updateGender(){$("#pMsgEditGender").text("กำลังดำเนินการ").css("color","blue").show();var e=localStorage.userId,t=$("#genderEditSelect").val(),o=serviceURL+"updateUserProfile.php";return $.ajax({type:"GET",url:o,contentType:"application/json",dataType:"jsonp",data:{userid:e,gender:t},crossDomain:!0,timeout:1e4,success:function(e){e.success===!0?(window.localStorage.userGender=t,getUserDetail(),getEditUserDetail(),$("#pMsgEditGender").text("เรียบร้อยแล้ว").css("color","green").fadeOut(3200)):$("#pMsgEditGender").text("มีบางอย่างผิดพลาด").css("color","red")},error:function(){navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต ")},complete:function(){console.log("complete")}}),!1}function updateBDate(){var e=moment($("#editBDate").val(),"DD-MM-YYYY").format("YYYY-MM-DD");$("#pMsgEditBdate").text("กำลังดำเนินการ").css("color","blue").show();var t=localStorage.userId,o=e,a=serviceURL+"updateUserProfile.php";return"Invalid date"!==e?$.ajax({type:"GET",url:a,contentType:"application/json",dataType:"jsonp",data:{userid:t,birthdate:o},crossDomain:!0,timeout:1e4,success:function(e){e.success===!0?(window.localStorage.userBdate=o,getUserDetail(),getEditUserDetail(),$("#pMsgEditBdate").text("เรียบร้อยแล้ว").css("color","green").fadeOut(3200)):$("#pMsgEditBdate").text("มีบางอย่างผิดพลาด").css("color","red")},error:function(){navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต ")},complete:function(){console.log("complete")}}):$("#pMsgEditBdate").text("กรุณากรอกวันเกิดให้ถูกต้อง").css("color","red").show(),!1}function updateEmail(){var e=localStorage.userId,t=$("#emailEditInput").val(),o=serviceURL+"updateUserProfile.php";return $.ajax({type:"GET",url:o,contentType:"application/json",dataType:"jsonp",data:{userid:e,email:t},crossDomain:!0,timeout:1e4,success:function(e){e.success===!0?(window.localStorage.userEmail=t,getUserDetail(),getEditUserDetail(),$("#pMsgEditE").text("เปลี่ยน Email เรียบร้อยแล้ว").css("color","green").fadeOut(3200)):$("#pMsgEditE").text("มีบางอย่างผิดพลาด").css("color","red")},error:function(){navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต ")},complete:function(){console.log("complete")}}),!1}function checkEditEmail(){if(editState===!0){var e=$("#emailEditInput").val(),t=serviceURL+"checkUsedEmail.php";return $("#pMsgEditE").text("กำลังดำเนินการ").css("color","blue").show(),""!==e?checkEmailRegEx(e)===!0?$.ajax({type:"GET",url:t,contentType:"application/json",dataType:"jsonp",data:{email:e},crossDomain:!0,timeout:1e4,success:function(e){e.success===!0?$("#pMsgEditE").text(" Email นี้มีผู้ใช้แล้ว").css("color","red"):($("#pMsgEditE").text(" Email นี้สามารถใช้ได้").css("color","green"),updateEmail())},error:function(){navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต")},complete:function(){console.log("message")}}):$("#pMsgEditE").text(" กรุณากรอก Email ให้ถูกต้อง ").css("color","red"):$("#pMsgEditE").text("กรุณากรอก Email").css("color","red"),!1}}function getOtherUserDetail(e){loadingShow("#contentOtherProfile"),$.mobile.loading("show");var t=serviceURL+"getOtherUserDetail.php",o=e,a=moment(),r="";$.ajax({type:"GET",url:t,contentType:"application/json",dataType:"jsonp",data:{otherUId:o},crossDomain:!0,timeout:1e4,success:function(e){jQuery.isEmptyObject(e)?navigator.notification.alert("failed",function(){}):(r="male"===e.user_gender?"ชาย":"female"===e.user_gender?"หญิง":"อื่นๆ",$("#imgOtherPropic").attr("src",serviceURL+"../img/userprofileimage/"+e.user_imageUrl+"?"+a.format()),$("#spNameOtherPro").text(e.user_rname+" "+e.user_surname),$("#spGenderOtherPro").text(r),$("#spBirthOtherPro").text(moment(e.user_bdate,"YYYY-MM-DD","th").format("LL")),$("#spEmailOtherPro").text(e.user_email),$("#getDetailThisUser").data("otherUId",e.user_id)),loadingHide("#contentOtherProfile"),$.mobile.loading("hide")},error:function(){navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต "),loadingHide("#contentOtherProfile"),$.mobile.loading("hide")},complete:function(){console.log("getOtherUserDetail complete")}})}function getCurrentPosition(){function e(e){globalLatitude=e.coords.latitude,globalLongitude=e.coords.longitude,globalAccuracy=e.coords.accuracy;var t="<div>Latitude: "+e.coords.latitude+"<br/>Longitude: "+e.coords.longitude+"<br/>Accuracy: "+e.coords.accuracy+"m<br/></div>";$("#cur_position").html(t);parseInt($("#map").css("width"),10),parseInt($("#map").css("height"),10);$("#map").attr("src","http://maps.googleapis.com/maps/api/staticmap?center="+e.coords.latitude+","+e.coords.longitude+"&zoom=16&size=400x400&maptype=roadmap&markers=color:green%7C"+e.coords.latitude+","+e.coords.longitude+"&sensor=false"),$("#map").css("visibility","visible"),$.ajax({url:"http://maps.googleapis.com/maps/api/geocode/json?latlng="+e.coords.latitude+","+e.coords.longitude+"&sensor=true&language=th",success:function(e){globalLocat=e.results[0].address_components[0].short_name+" "+e.results[0].address_components[1].short_name+" "+e.results[0].address_components[2].short_name+" "+e.results[0].address_components[3].short_name,$("#spMiniLocat").text(globalLocat)}})}function t(e){alert(JSON.stringify(e)),$("#cur_position").html("Error getting geolocation: "+error.code)}globalAddReportImageURI=null,globalLatitude=null,globalLongitude=null,globalAccuracy=null;var o=moment();$("#imgMiniPropic").attr("src",serviceURL+"../img/userprofileimage/"+localStorage.userImageUrl+"?"+o.format()),validReport();var a={enableHighAccuracy:!0,timeout:6e4,maximumAge:6e5};$("#cameraImage").css("visibility","hidden"),$("#map").css("visibility","hidden"),$("#cur_position").html("Getting geolocation . . ."),navigator.geolocation.getCurrentPosition(e,t,a)}function onPhotoURISuccess(e){var t=document.getElementById("cameraImage");t.src=e,$("#cameraImage").css("visibility","visible"),globalAddReportImageURI=e,validReport()}function testGlobalURI(){}function take_pic(){navigator.camera.getPicture(onPhotoURISuccess,onFail,{quality:80,destinationType:Camera.DestinationType.FILE_URI,sourceType:Camera.PictureSourceType.CAMERA,targetWidth:320,targetHeight:320,correctOrientation:1,saveToPhotoAlbum:0,allowEdit:1})}function album_pic(){clearCache(),navigator.camera.getPicture(onPhotoURISuccess,onFail,{quality:80,destinationType:Camera.DestinationType.FILE_URI,sourceType:Camera.PictureSourceType.PHOTOLIBRARY,targetWidth:320,targetHeight:320,correctOrientation:1,saveToPhotoAlbum:0,allowEdit:1})}function onFail(e){alert("Failed because: "+e)}function addReportBindEvent(){var e=moment();$("#reportTitleInput").on("focusout",function(){$("#reportTitleInput").val()?(titleState=!0,validReport()):(titleState=!1,validReport())}).on("keyup",function(){$("#reportTitleInput").val()?(titleState=!0,validReport()):(titleState=!1,validReport())}),$("#reportContentInput").on("keyup",function(){$("#reportContentInput").val()?(contentState=!0,validReport()):(contentState=!1,validReport())}).on("focusout",function(){$("#reportContentInput").val()?(contentState=!0,validReport()):(contentState=!1,validReport())}),$("#imgMiniPropic").attr("src",serviceURL+"../img/userprofileimage/"+localStorage.userImageUrl+"?"+e.format()),$("#spNameMiniPro").text(localStorage.userRName+" "+localStorage.userSurname),$("#spMiniLocat").text(),$("#spDateMini").text(e.format("DD MMMM YYYY")),startTime(),validReport()}function startTime(){var e=moment();$("#spTimeMini").text(e.format("HH:mm:ss"));setTimeout(function(){startTime()},500)}function validReport(){return null!==globalAddReportImageURI&&null!==globalLatitude&&null!==globalLongitude&&null!==globalAccuracy&&null!==globalLocat&&titleState!==!1&&contentState!==!1?($("#addRepSumitBtn").removeClass("ui-state-disabled"),!0):($("#addRepSumitBtn").addClass("ui-state-disabled"),!1)}function handleAddreport(){loadingShow("#contentAddReport");var e=moment().format("YYYY-MM-DD HH:mm:ss"),t=new FileUploadOptions;t.fileKey="file",t.fileName=globalAddReportImageURI.substr(globalAddReportImageURI.lastIndexOf("/")+1),t.mimeType="image/jpeg";var o=new Object;o.userId=localStorage.userId,o.dateEvent=e,o.title=$("#reportTitleInput").val(),o.content=$("#reportContentInput").val(),o.latitude=globalLatitude,o.longitude=globalLongitude,o.locat=globalLocat,o.group=localStorage.userGroup,t.params=o,t.chunkedMode=!1;var a=new FileTransfer;a.upload(globalAddReportImageURI,encodeURI(serviceURL+"addReport.php"),win,fail,t)}function win(){alert("เพิ่มรายงานเรียบร้อยแล้ว!"),loadFeed(),window.history.back(),loadingHide("#contentAddReport")}function fail(e){loadingHide("#contentAddReport"),alert("An error has occurred: Code = "+e.code)}function getEditReport(e,t,o){$("#sumitEditRpBtn").addClass("ui-state-disabled"),idReport=e,clearCache();moment();$("#editReportTitleInput").val(t),$("#editReportContentInput").val(decodeURI(o))}function editReportBindEvent(){$("#editReportTitleInput").on("focusin",function(){editState=!1}).on("keyup",function(){editState=!0,$("#sumitEditRpBtn").removeClass("ui-state-disabled")}).on("focusout",updateReportTitle),$("#editReportContentInput").on("focusin",function(){editState=!1}).on("keyup",function(){editState=!0,$("#sumitEditRpBtn").removeClass("ui-state-disabled")}).on("focusout",updateReportContent)}function updateReportTitle(){var e,t=0,o=idReport,a=serviceURL+"updateReport.php";return editState===!0?($("#pMsgEditReport").text("กำลังดำเนินการ").css("color","blue").show(),e=$("#editReportTitleInput").val(),""!==e?$.ajax({type:"GET",url:a,contentType:"application/json",dataType:"jsonp",data:{edittype:t,reportid:o,editval:e},crossDomain:!0,timeout:1e4,success:function(e){e.success===!0?(loadThisUserReport(),$("#pMsgEditReport").text("แก้ไขข้อมูล เรียบร้อยแล้ว").css("color","green").fadeOut(3200)):$("#pMsgEditReport").text("มีบางอย่างผิดพลาด").css("color","red").fadeOut(3200)},error:function(){navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต ")},complete:function(){}}):$("#pMsgEditReport").text("กรุณากรอกข้อมูล!").css("color","red").show().fadeOut(3200),!1):void 0}function updateReportContent(){var e,t=1,o=idReport,a=serviceURL+"updateReport.php";return editState===!0?($("#pMsgEditReport").text("กำลังดำเนินการ").css("color","blue").show(),e=$("#editReportContentInput").val(),""!==e?$.ajax({type:"GET",url:a,contentType:"application/json",dataType:"jsonp",data:{edittype:t,reportid:o,editval:e},crossDomain:!0,timeout:1e4,success:function(e){e.success===!0?(loadThisUserReport(),$("#pMsgEditReport").text("แก้ไขข้อมูล เรียบร้อยแล้ว").css("color","green").fadeOut(2e3)):$("#pMsgEditReport").text("มีบางอย่างผิดพลาด").css("color","red").fadeOut(3200)},error:function(){navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต ")},complete:function(){}}):$("#pMsgEditReport").text("กรุณากรอกข้อมูล!").css("color","red").show().fadeOut(3200),!1):void 0}function setDelReportId(e){idReport=null,idReport=e}function deleteReport(){var e=idReport,t=serviceURL+"deleteReport.php";$.ajax({type:"GET",url:t,contentType:"application/json",dataType:"jsonp",data:{reportid:e},crossDomain:!0,timeout:1e4,success:function(e){e.success===!0?(loadThisUserReport(),navigator.notification.alert("ลบข้อมูล เรียบร้อยแล้ว")):navigator.notification.alert("มีบางอย่างผิดพลาด")},error:function(){navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต ")},complete:function(){console.log("complete")}})}function backHistory(){window.history.back()}function loadThisUserReport(){uid=window.localStorage.userId,loadUserReport()}function loadOtherUserReport(){uid=$("#getDetailThisUser").data("otherUId"),loadUserReport()}function loadUserReport(){clearCache(),loadingShow("#contentUserReport");var e=$("#userReportMiddle");e.empty(),$("#userReportBottom").empty(),$("#userReportTop").empty();var t=serviceURL+"loadUserReport.php";$.ajax({type:"GET",url:t,contentType:"application/json",dataType:"jsonp",data:{userid:uid},crossDomain:!0,timeout:1e4,success:function(t){jQuery.isEmptyObject(t)?(loadingHide("#contentUserReport"),$("#pMsgUserReport").text("คุณยังไม่มีรายงาน.").show().css("color","green").fadeOut(3200)):$.each(t,function(t,o){uid===window.localStorage.userId?htmlReportUser(o):htmlReport(o),e.append(reportHtml),loadingHide("#contentUserReport")})},error:function(){e.text("พบข้อผิดพลาดในการโหลดข้อมูล!!").show().css("color","red").fadeOut(3200),loadingHide("#contentUserReport")}})}function loadNewUserReport(){var e=$("#userReportTop"),t="new",o=serviceURL+"loadUserReport.php";if(0===e.html().length){var a=$("#userReportMiddle").children("div:first-child"),r=a.data("report-date"),i=a.data("report-id");loadNewUserReportAjax(e,t,o,a,r,i)}else{var a=$("#userReportTop").children("div:first-child"),r=a.data("report-date"),i=a.data("report-id");loadNewUserReportAjax(e,t,o,a,r,i)}}function loadNewUserReportAjax(e,t,o,a,r,i){$.ajax({type:"GET",url:o,contentType:"application/json",dataType:"jsonp",data:{userid:uid,userReportFlag:t,lastRepViewDate:r,lastRepViewId:i},crossDomain:!0,timeout:1e4,success:function(t){jQuery.isEmptyObject(t)?$("#pMsgUserReport").text("ฟีดข่าวล่าสุดแล้ว.").show().css("color","green").fadeOut(3200):$.each(t,function(t,o){uid===window.localStorage.userId?htmlReportUser(o):htmlReport(o),e.prepend(reportHtml)})},error:function(){e.text("พบข้อผิดพลาดในการโหลดข้อมูล!!").show().css("color","red").fadeOut(3200)}})}function loadOldUserReport(){var e=$("#userReportBottom"),t="old",o=serviceURL+"loadUserReport.php";if(0===e.html().length){var a=$("#userReportMiddle").children("div:last-child"),r=a.data("report-date"),i=a.data("report-id");loadOldUserReportAjax(e,t,o,a,r,i)}else{var a=$("#userReportBottom").children("div:last-child"),r=a.data("report-date"),i=a.data("report-id");loadOldUserReportAjax(e,t,o,a,r,i)}}function loadOldUserReportAjax(e,t,o,a,r,i){$.ajax({type:"GET",url:o,contentType:"application/json",dataType:"jsonp",data:{userid:uid,userReportFlag:t,lastRepViewDate:r,lastRepViewId:i},crossDomain:!0,timeout:1e4,success:function(t){jQuery.isEmptyObject(t)?$("#pMsgUserReportB").text("ฟีดข่าวเก่าสุดแล้ว.").show().css("color","green").fadeOut(3200):$.each(t,function(t,o){uid===window.localStorage.userId?htmlReportUser(o):htmlReport(o),e.append(reportHtml)})},error:function(){e.text("พบข้อผิดพลาดในการโหลดข้อมูล!!").show().css("color","red").fadeOut(3200)}})}function htmlReportUser(e){var t=moment(),o=moment(e.report_date,"YYYY-MM-DD HH:mm:ss","th");reportHtml='<div class="ui-corner-all custom-corners" id="reportView" data-report-date="'+e.report_date+'" data-report-id="'+e.report_id+'" data-report-by="'+e.report_by+'"><a href="#otherProfilePage" class="ui-corner-all" id="lnkThisUpro" onClick="getOtherUserDetail(\''+e.report_by+'\')"><div class="ui-bar ui-bar-b"><h3><strong><span id="spNameFeed">'+e.report_realNameBy+'</span></strong></h3></div></a><div class="ui-body ui-body-a"><div class="ui-grid-a"><div class="ui-block-a" id="miniPropicHome"><img alt="" height="40" id="imgMiniPropicHome" src="'+serviceURL+"../img/userprofileimage/"+e.report_userImageUrl+"?"+t.format()+'" width="40"></div><div class="ui-block-b" id="miniReportdetail">วันที่: <span id="spDateReport">'+o.format("DD MMMM YYYY")+'</span><br>เวลา: <em><span id="spTimeReport">'+o.format("HH:mm:ss")+'</span></em></div></div><div class="ui-grid-solo"><b>หัวเรื่อง:</b> <span id="spTitle">'+e.report_title+'</span><br><b>รายละเอียด:</b> <em><span id="spContent">'+e.report_content+'</span></em><br><br><a href="#fullImgPage" class="lnkThisImg" onClick="getFullImg(\''+e.report_imgUrl+'\')"><img align="center" alt="" id="imgReport" src="'+serviceURL+"../img/reportPic/"+e.report_imgUrl+"?"+t.format()+'"></a><b>สถานที่:</b> <em><span id="spLocatReport">'+e.report_locat+'</span></em><br><a href="#mapPage" id="lnkThisMap" data-ajax="false" onClick="showThisMap('+e.report_lat+", "+e.report_long+')"><img id="imgMapReport" src="http://maps.googleapis.com/maps/api/staticmap?center='+e.report_lat+","+e.report_long+"&zoom=16&size=400x400&maptype=roadmap&markers=color:green%7C"+e.report_lat+","+e.report_long+'&sensor=true"></a><div class="ui-grid-a"><div class="ui-block-a"><a class="ui-btn ui-mini ui-icon-refresh ui-btn-icon-left ui-corner-all activeOnce" href="#editReportPage" id="editUserReportBtn" data-transition="none" onClick="getEditReport(\''+e.report_id+"', '"+e.report_title+"', '"+encodeURI(e.report_content)+'\');">แก้ไข</a></div><div class="ui-block-b"><a class="ui-btn ui-mini ui-icon-refresh ui-btn-icon-left ui-corner-all activeOnce" href="#deleteReportDialog" id="delReportPopupBtn" data-rel="popup" data-position-to="window" data-transition="pop" onClick="setDelReportId(\''+e.report_id+"')\">ลบ</a></div></div></div></div><br>"
}function loadFeed(){clearCache(),loadingShow("#contentHome");var e=$("#feedMiddle");e.empty(),$("#feedBottom").empty(),$("#feedTop").empty();var t=serviceURL+"loadFeed.php";$.ajax({url:t,dataType:"jsonp",timeout:1e4,success:function(t){$.each(t,function(t,o){htmlReport(o),e.append(reportHtml),loadingHide("#contentHome")})},error:function(){e.text("พบข้อผิดพลาดในการโหลดข้อมูล!!"),loadingHide("#contentHome"),navigator.notification.confirm("พบข้อผิดพลาดในการโหลดข้อมูล!!โหลดใหม่หรือไม่?",loadFeedCallback,"Error","ไม่,ลองอีกครั้ง")}})}function loadNewFeed(){var e=$("#feedTop"),t="new",o=serviceURL+"loadFeed.php";if(0===e.html().length){var a=$("#feedMiddle").children("div:first-child"),r=a.data("report-date"),i=a.data("report-id");loadNewFeedAjax(e,t,o,a,r,i)}else{var a=$("#feedTop").children("div:first-child"),r=a.data("report-date"),i=a.data("report-id");loadNewFeedAjax(e,t,o,a,r,i)}}function loadNewFeedAjax(e,t,o,a,r,i){$.ajax({type:"GET",url:o,contentType:"application/json",dataType:"jsonp",data:{feedFlag:t,lastRepViewDate:r,lastRepViewId:i},crossDomain:!0,timeout:1e4,success:function(t){jQuery.isEmptyObject(t)?$("#pMsgFeed").text("ฟีดข่าวล่าสุดแล้ว.").show().css("color","green").fadeOut(3200):$.each(t,function(t,o){htmlReport(o),e.prepend(reportHtml)})},error:function(){e.text("พบข้อผิดพลาดในการโหลดข้อมูล!!")}})}function loadOldFeed(){var e=$("#feedBottom"),t="old",o=serviceURL+"loadFeed.php";if(0===e.html().length){var a=$("#feedMiddle").children("div:last-child"),r=a.data("report-date"),i=a.data("report-id");loadOldFeedAjax(e,t,o,a,r,i)}else{var a=$("#feedBottom").children("div:last-child"),r=a.data("report-date"),i=a.data("report-id");loadOldFeedAjax(e,t,o,a,r,i)}}function loadOldFeedAjax(e,t,o,a,r,i){$.ajax({type:"GET",url:o,contentType:"application/json",dataType:"jsonp",data:{feedFlag:t,lastRepViewDate:r,lastRepViewId:i},crossDomain:!0,timeout:1e4,success:function(t){jQuery.isEmptyObject(t)?$("#pMsgFeedB").text("ฟีดข่าวเก่าสุดแล้ว.").show().css("color","green").fadeOut(3200):$.each(t,function(t,o){htmlReport(o),e.append(reportHtml)})},error:function(){e.text("พบข้อผิดพลาดในการโหลดข้อมูล!!")}})}function htmlReport(e){var t=moment(),o=moment(e.report_date,"YYYY-MM-DD HH:mm:ss","th");reportHtml='<div class="ui-corner-all custom-corners" id="reportView" data-report-date="'+e.report_date+'" data-report-id="'+e.report_id+'" data-report-by="'+e.report_by+'"><a href="#otherProfilePage" class="ui-corner-all" id="lnkThisUpro" onClick="getOtherUserDetail(\''+e.report_by+'\')"><div class="ui-bar ui-bar-b"><h3><strong><span id="spNameFeed">'+e.report_realNameBy+'</span></strong></h3></div></a><div class="ui-body ui-body-a"><div class="ui-grid-a"><div class="ui-block-a" id="miniPropicHome"><img alt="" height="40" id="imgMiniPropicHome" src="'+serviceURL+"../img/userprofileimage/"+e.report_userImageUrl+"?"+t.format()+'" width="40"></div><div class="ui-block-b" id="miniReportdetail">วันที่: <span id="spDateReport">'+o.format("DD MMMM YYYY")+'</span><br>เวลา: <em><span id="spTimeReport">'+o.format("HH:mm:ss")+'</span></em></div></div><div class="ui-grid-solo"><b>หัวเรื่อง:</b> <span id="spTitle">'+e.report_title+'</span><br><b>รายละเอียด:</b> <em><span id="spContent">'+e.report_content+'</span></em><br><br><a href="#fullImgPage" class="lnkThisImg" onClick="getFullImg(\''+e.report_imgUrl+'\')"><img align="center" alt="" id="imgReport" src="'+serviceURL+"../img/reportPic/"+e.report_imgUrl+"?"+t.format()+'"></a><b>สถานที่:</b> <em><span id="spLocatReport">'+e.report_locat+'</span></em><br><a href="#mapPage" id="lnkThisMap" data-ajax="false" onClick="showThisMap('+e.report_lat+", "+e.report_long+')"><img id="imgMapReport" src="http://maps.googleapis.com/maps/api/staticmap?center='+e.report_lat+","+e.report_long+"&zoom=16&size=400x400&maptype=roadmap&markers=color:green%7C"+e.report_lat+","+e.report_long+'&sensor=true"></a></a></div></div><br>'}function loadUserGroup(){if(clearCache(),gid=localStorage.userGroup,"000000"!==gid){loadingShow("#contentGroup");var e=serviceURL+"loadGroupDetail.php";$.ajax({type:"GET",url:e,contentType:"application/json",dataType:"jsonp",data:{groupid:gid},crossDomain:!0,timeout:1e4,success:function(e){jQuery.isEmptyObject(e)?navigator.notification.alert("Load Group Detail failed",function(){}):($("#spGroupName").text(e.group_name),$("#spGroupDetail").text(e.group_detail),uid=window.localStorage.userId,loadGroupFeed()),loadingHide("#contentGroup")},error:function(){navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต "),loadingHide("#contentGroup")},complete:function(){$("#submitButton").removeAttr("disabled"),loadingHide("#contentGroup")}})}else $("#spGroupName").text("ยังไม่ได้เลือกกลุ่ม"),$("#spGroupDetail").text(" ยังไม่มีรายละเอียดกลุ่ม. กรุณาเลือกหรือสร้างกลุ่ม")}function loadGroupFeed(){loadingShow("#contentGroup");var e=$("#feedGroupMiddle");e.empty(),$("#feedGroupBottom").empty(),$("#feedGroupTop").empty();var t=serviceURL+"loadGroupReport.php";$.ajax({type:"GET",url:t,contentType:"application/json",dataType:"jsonp",data:{groupid:gid,userid:uid},crossDomain:!0,timeout:1e4,success:function(t){$.each(t,function(t,o){htmlReport(o),e.append(reportHtml),loadingHide("#contentGroup")})},error:function(){e.text("พบข้อผิดพลาดในการโหลดข้อมูล!!").show().css("color","red").fadeOut(3200),loadingHide("#contentGroup")}})}function loadNewGroupFeed(){var e=$("#feedGroupTop"),t="new",o=serviceURL+"loadGroupReport.php";if(0===e.html().length){var a=$("#feedGroupMiddle").children("div:first-child"),r=a.data("report-date"),i=a.data("report-id");loadNewGroupFeedAjax(e,t,o,a,r,i)}else{var a=$("#feedGroupTop").children("div:first-child"),r=a.data("report-date"),i=a.data("report-id");loadNewGroupFeedAjax(e,t,o,a,r,i)}}function loadNewGroupFeedAjax(e,t,o,a,r,i){$.ajax({type:"GET",url:o,contentType:"application/json",dataType:"jsonp",data:{groupid:gid,userid:uid,userReportFlag:t,lastRepViewDate:r,lastRepViewId:i},crossDomain:!0,timeout:1e4,success:function(t){jQuery.isEmptyObject(t)?$("#pMsgGroupFeed").text("ฟีดข่าวล่าสุดแล้ว.").show().css("color","green").fadeOut(3200):$.each(t,function(t,o){htmlReport(o),e.prepend(reportHtml)})},error:function(){e.text("พบข้อผิดพลาดในการโหลดข้อมูล!!").show().css("color","red").fadeOut(3200)}})}function loadOldGroupFeed(){var e=$("#feedGroupBottom"),t="old",o=serviceURL+"loadGroupReport.php";if(0===e.html().length){var a=$("#feedGroupMiddle").children("div:last-child"),r=a.data("report-date"),i=a.data("report-id");loadOldGroupFeedAjax(e,t,o,a,r,i)}else{var a=$("#feedGroupBottom").children("div:last-child"),r=a.data("report-date"),i=a.data("report-id");loadOldGroupFeedAjax(e,t,o,a,r,i)}}function loadOldGroupFeedAjax(e,t,o,a,r,i){$.ajax({type:"GET",url:o,contentType:"application/json",dataType:"jsonp",data:{groupid:gid,userid:uid,userReportFlag:t,lastRepViewDate:r,lastRepViewId:i},crossDomain:!0,timeout:1e4,success:function(t){jQuery.isEmptyObject(t)?$("#pMsgGroupFeedB").text("ฟีดข่าวเก่าสุดแล้ว.").show().css("color","green").fadeOut(3200):$.each(t,function(t,o){htmlReport(o),e.append(reportHtml)})},error:function(){e.text("พบข้อผิดพลาดในการโหลดข้อมูล!!").show().css("color","red").fadeOut(3200)}})}function getSelectGroupData(){clearCache(),loadingShow("#contentSelectGroup");var e=$("#selectGroupList");e.empty();var t=serviceURL+"loadAllGroup.php",o="";$.ajax({url:t,dataType:"jsonp",timeout:1e4,success:function(t){$.each(t,function(t,a){o='<li><a href="#showGroupPage" onClick="getOneGroupData('+a.group_id+');">'+a.group_name+"</a></li>",e.append(o),e.listview("refresh")}),loadingHide("#contentSelectGroup")},error:function(){e.text("พบข้อผิดพลาดในการโหลดข้อมูล!!"),loadingHide("#contentSelectGroup")}})}function getOneGroupData(e){loadingShow("#contentShowGroup");var t=e;globalGId=t;var o=serviceURL+"loadGroupDetail.php";$.ajax({type:"GET",url:o,contentType:"application/json",dataType:"jsonp",data:{groupid:t},crossDomain:!0,timeout:1e4,success:function(e){jQuery.isEmptyObject(e)?navigator.notification.alert("Load Group Detail failed",function(){}):($("#spOneGroupName").text(e.group_name),$("#spOneGroupDetail").text(e.group_detail),loadOneGroupFeed(t)),loadingHide("#contentShowGroup")},error:function(){navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต "),loadingHide("#contentShowGroup")},complete:function(){loadingHide("#contentShowGroup")}})}function loadOneGroupFeed(e){loadingShow("#contentShowGroup");var t=$("#feedGroupOne");uid=window.localStorage.userId;var o=e;t.empty();var a=serviceURL+"loadGroupReport.php";$.ajax({type:"GET",url:a,contentType:"application/json",dataType:"jsonp",data:{groupid:o,userid:uid},crossDomain:!0,timeout:1e4,success:function(e){$.each(e,function(e,o){htmlReport(o),t.append(reportHtml),loadingHide("#contentShowGroup")})},error:function(){t.text("พบข้อผิดพลาดในการโหลดข้อมูล!!").show().css("color","red").fadeOut(3200),loadingHide("#contentShowGroup")}})}function loadOldGroupOne(){var e=$("#feedGroupOneBottom"),t="old",o=serviceURL+"loadGroupReport.php";if(0===e.html().length){var a=$("#feedGroupOne").children("div:last-child"),r=a.data("report-date"),i=a.data("report-id");loadOldGroupOneAjax(e,t,o,a,r,i)}else{var a=$("#feedGroupOneBottom").children("div:last-child"),r=a.data("report-date"),i=a.data("report-id");loadOldGroupOneAjax(e,t,o,a,r,i)}}function loadOldGroupOneAjax(e,t,o,a,r,i){$.ajax({type:"GET",url:o,contentType:"application/json",dataType:"jsonp",data:{groupid:tgid,userid:uid,userReportFlag:t,lastRepViewDate:r,lastRepViewId:i},crossDomain:!0,timeout:1e4,success:function(t){jQuery.isEmptyObject(t)?$("#spGroupOneB").text("ฟีดข่าวเก่าสุดแล้ว.").show().css("color","green").fadeOut(3200):$.each(t,function(t,o){htmlReport(o),e.append(reportHtml)})},error:function(){e.text("พบข้อผิดพลาดในการโหลดข้อมูล!!").show().css("color","red").fadeOut(3200)}})}function selectThisGroup(){var e=localStorage.userId,t=globalGId,o=serviceURL+"updateUserProfile.php";return $.ajax({type:"GET",url:o,contentType:"application/json",dataType:"jsonp",data:{userid:e,usergroup:t},crossDomain:!0,timeout:1e4,success:function(e){e.success===!0?(window.localStorage.userGroup=t,gid=t,checkGroup(),loadUserGroup(),window.history.back(),navigator.notification.alert("เลือกกลุ่มเรียบร้อยแล้ว."),regisThisDevice()):$("#spGroupOne").text("มีบางอย่างผิดพลาด").css("color","red")},error:function(){navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต ")},complete:function(){console.log("complete")}}),!1}function createGroup(){var e=serviceURL+"regisGroup.php";$("#crGrpSubmitBtn").addClass("ui-state-disabled");var t=$("#crGrpTitleInput").val(),o=$("#crGrpContentInput").val(),a=$("#crGrpCityInput").val(),r=moment().format("YYYY-MM-DD HH:mm:ss");return loadingShow("#contentCreateGroup"),validCreateGroup()?$.ajax({type:"GET",url:e,contentType:"application/json",dataType:"jsonp",data:{crgrpname:t,crgrpcontent:o,crgrpcity:a,crgrpdate:r},crossDomain:!0,timeout:1e4,success:function(e){jQuery.isEmptyObject(e)?navigator.notification.alert("การสร้างกลุ่มเกิดข้อผิดพลาด",function(){}):(window.localStorage.userGroup=e.group_id,selectThisNewGroup(),$("#crGrpTitleInput").text(""),$("#crGrpContentInput").text(""),$("#crGrpCityInput").text(""),$("#spcrGrpName").text(""),crGrptitleState=!1,crGrpcontentState=!1,crGrpCityState=!1,validCreateGroup(),checkGroup()),$("#crGrpSubmitBtn").removeClass("ui-state-disabled"),loadingHide("#contentCreateGroup")},error:function(){navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต "),$("#crGrpSubmitBtn").removeClass("ui-state-disabled"),loadingHide("#contentCreateGroup")},complete:function(){console.log("message")}}):(navigator.notification.alert("กรุณากรอก ชื่อกลุ่มที่จะสร้าง"),$("#crGrpSubmitBtn").removeClass("ui-state-disabled"),loadingHide("#contentRegis")),!1}function createGroupBindEvent(){$("#crGrpTitleInput").on("focusout",function(){$("#crGrpTitleInput").val()?(crGrptitleState=!0,validCreateGroup(),checkUsedGroup()):(crGrptitleState=!1,validCreateGroup())}).on("keyup",function(){$("#crGrpTitleInput").val()?(crGrptitleState=!0,validCreateGroup()):(crGrptitleState=!1,validCreateGroup())}),$("#crGrpContentInput").on("change",function(){$("#crGrpContentInput").val()?(crGrpcontentState=!0,validCreateGroup()):(crGrpcontentState=!1,validCreateGroup())}),$("#crGrpCityInput").on("keyup",function(){$("#crGrpCityInput").val()?(crGrpCityState=!0,validCreateGroup()):(crGrpCityState=!1,validCreateGroup())}),validCreateGroup()}function validCreateGroup(){return crGrptitleState!==!1&&crGrpcontentState!==!1&&crGrpCityState!==!1?($("#crGrpSubmitBtn").removeClass("ui-state-disabled"),!0):($("#crGrpSubmitBtn").addClass("ui-state-disabled"),!1)}function checkUsedGroup(){var e=$("#crGrpTitleInput").val(),t=serviceURL+"checkUsedGroup.php";return""!==e?$.ajax({type:"GET",url:t,contentType:"application/json",dataType:"jsonp",data:{groupname:e},crossDomain:!0,timeout:1e4,success:function(t){t.success===!0?(crGrptitleState=!1,validCreateGroup(),$("#spcrGrpName").text(e+" ชื่อกลุ่มนี้มีผู้ใช้แล้ว").css("color","red")):(crGrptitleState=!0,validCreateGroup(),$("#spcrGrpName").text(e+" ชื่อกลุ่มนี้สามารถใช้ได้").css("color","green"))},error:function(){crGrptitleState=!1,validCreateGroup(),navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต ")},complete:function(){}}):(crGrptitleState=!1,validCreateGroup(),$("#spcrGrpName").text("กรุณากรอก ชื่อกลุ่มที่จะสร้าง").css("color","red")),!1}function selectThisNewGroup(){var e=localStorage.userId,t=window.localStorage.userGroup,o=serviceURL+"updateUserProfile.php";return $.ajax({type:"GET",url:o,contentType:"application/json",dataType:"jsonp",data:{userid:e,usergroup:t},crossDomain:!0,timeout:1e4,success:function(e){e.success===!0?(window.localStorage.userGroup=t,gid=t,loadUserGroup(),navigator.notification.alert("เลือกกลุ่มเรียบร้อยแล้ว."),regisThisDevice()):$("#spGroupOne").text("มีบางอย่างผิดพลาด").css("color","red")},error:function(){navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต ")},complete:function(){console.log("complete")}}),!1}function clearSearchFilter(){$('input[data-type="search"]').val(""),$('input[data-type="search"]').trigger("keyup")}function loadOneReport(e){clearCache(),loadingShow("#contentOneReport");var t=e,o=$("#oneReportDive");o.empty();var a=serviceURL+"loadOneReport.php";$.ajax({type:"GET",url:a,contentType:"application/json",dataType:"jsonp",data:{reportid:t},crossDomain:!0,timeout:1e4,success:function(e){$.each(e,function(e,t){htmlReport(t),o.append(reportHtml),loadingHide("#contentOneReport")})},error:function(){o.text("พบข้อผิดพลาดในการโหลดข้อมูล!!"),loadingHide("#contentOneReport")}})}function regisThisDevice(){device.uuid;try{pushNotification=window.plugins.pushNotification,("android"==device.platform||"Android"==device.platform||"amazon-fireos"==device.platform)&&pushNotification.register(successHandler,errorHandler,{senderID:"320077907247",ecb:"onNotification"})}catch(e){txt="There was an error on this page.\n\n",txt+="Error description: "+e.message+"\n\n",alert(txt)}}function onNotification(e){var t=window.localStorage.userId,o=window.localStorage.userGroup;switch(e.event){case"registered":e.regid.length>0&&$.post(php_addRegist,{did:device.uuid,regid:e.regid,uid:t,grpid:o,datetime:moment().format("YYYY-MM-DD HH:mm:ss")},function(e){console.log(e)});break;case"message":e.foreground?(console.log("--INLINE NOTIFICATION--"),navigator.notification.beep(1)):console.log(e.coldstart?"--COLDSTART NOTIFICATION--":"--BACKGROUND NOTIFICATION--"),countNotify(),console.log("MESSAGE -> MSG: "+e.payload.message+e.payload.title);break;case"error":console.log("ERROR -> MSG: "+e.msg);break;default:console.log("EVENT -> Unknown, an event was received and we do not know what it is")}}function successHandler(e){console.log("success: "+e)}function errorHandler(e){console.log("error: "+e)}function deleteThisDevice(){var e=(device.uuid,serviceURL+"deleteDevice.php");$.ajax({type:"GET",url:e,contentType:"application/json",dataType:"jsonp",data:{did:device.uuid},crossDomain:!0,timeout:1e4,success:function(e){e.success===!0?console.log("ลบข้อมูล เรียบร้อยแล้ว"):navigator.notification.alert("มีบางอย่างผิดพลาด")},error:function(){navigator.notification.alert("ERROR กรุณาตรวจสอบการเชื่อมต่อ อินเตอร์เน็ต ")},complete:function(){console.log("complete")}})}function showMap(){function e(e){refreshIntervalId=setInterval(function(){o(new google.maps.LatLng(e.coords.latitude,e.coords.longitude))},300)}function t(){refreshIntervalId=setInterval(function(){o(a)},300)}function o(e){clearInterval(refreshIntervalId);{var t={zoom:10,center:e,mapTypeId:google.maps.MapTypeId.ROADMAP},o=new google.maps.Map(document.getElementById("map-canvas"),t);new google.maps.Marker({position:e,map:o,title:"Greetings!"})}}var a=new google.maps.LatLng(34.0983425,-118.3267434);navigator.geolocation?navigator.geolocation.getCurrentPosition(e,t,{maximumAge:5e5,enableHighAccuracy:!0,timeout:6e3}):refreshIntervalId=setInterval(function(){o(a)},300)}function showThisMap(e,t){function o(e){0!==refreshIntervalId&&clearInterval(refreshIntervalId),refreshIntervalId=0;{var t={zoom:15,center:e,mapTypeId:google.maps.MapTypeId.ROADMAP},o=new google.maps.Map(document.getElementById("map-canvas"),t);new google.maps.Marker({position:e,map:o,title:"Greetings!"})}}clearCache();var a=new google.maps.LatLng(e,t);refreshIntervalId=setInterval(function(){o(a)},2e3)}function getFullImg(e){var t=moment();$("#imgFullImg").attr("src",serviceURL+"../img/reportPic/"+e+"?"+t.format())}var serviceURL=localStorage.serviceURL;$(document).ready(function(){FastClick.attach(document.body),loadingShow("#firstPage"),document.addEventListener("deviceready",deviceReady,!0),mainMenuSet(),userFooterSet(),getCurrentPosition(),$("#loginPage").on("pagecreate",loginBindEvent),$("#regisPage").on("pagecreate",regisBindEvent),$("#editProfilePage").on("pagecreate",editUserBindEvent),$("#addReportPage").on("pagecreate",addReportBindEvent),$("#editReportPage").on("pagecreate",editReportBindEvent),$("#createGroupPage").on("pagecreate",createGroupBindEvent),$("#homePage").on("pagecreate",function(){checkGroup(),loadFeed(),countNotifyGet()}),$(".spNotify").on("click",function(){countNotifyReset(),$.mobile.changePage("#groupPage"),loadUserGroup()})}),$("#mapPage").on("pageshow",function(){var e=map.getCenter();google.maps.event.trigger(map,"resize"),map.setCenter(e)});var serviceURL=localStorage.serviceURL,userState=!1,passState=!1,emailState=!1,realNameState=!1,realSNameState=!1,bDateState=!1,userMsgD=" สามารถใช้อักษร a-z,0-9,_,- ความยาว 4-15 ตัว ",passMsgD=" สามารถใช้อักษร a-Z,0-9,_,- ความยาว 5-15 ตัว ",globalProfileImageURI,editState=!1,globalAddReportImageURI=null,globalLatitude=null,globalLongitude=null,globalAccuracy=null,globalDateTime=null,globalLocat=null,titleState=!1,contentState=!1,editState,idReport,uid,reportHtml,gid,globalGId=0,crGrptitleState=!1,crGrpcontentState=!1,crGrpCityState=!1;$(document).on("pagecreate","#searchPage",function(){$("#searchAutocomplete").on("filterablebeforefilter",function(e,t){var o=$(this),a=$(t.input),r=a.val(),i=serviceURL+"searchReport.php";o.html(""),r&&r.length>0&&(o.html("<li><div class='ui-loader'><span class='ui-icon ui-icon-loading'></span></div></li>"),o.listview("refresh"),$.ajax({url:i,crossDomain:!0,data:{query:a.val()}}).then(function(e){o.html(e),o.listview("refresh"),o.trigger("updatelayout")}))})});var pushNotification,php_addRegist=serviceURL+"addDeviceRegis.php",notifyCount=window.localStorage.getItem("notifyCount"),count,refreshIntervalId=0;